---
title: "DSjobtracker - Data visualisation"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
```





Column {data-width=800}
-----------------------------------------------------------------------
#### Countrywise composition of number of Statistical Job Advertistments 
```{r}
devtools::install_github("thiyangt/DSjobtracker")
library(DSjobtracker)
library(maps)
library(viridis)
library(mapproj)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggrepel)
library(plotly)
library(R.utils)

#Importing the data sets

data("DStidy")
data<-map_data("world")
worlddata<-data.frame(world.cities)

#Taking to same consistency

worlddata[worlddata=="USA"]<-"United States"
worlddata[worlddata=="UK"]<-"United Kingdom"


#Making a frequency table of vacanvies for the countries


summaries<-as.data.frame(table(DStidy$Job_Country))
colnames(summaries)<-c("country.etc","Frequency")


#Making to lower case

summaries$country.etc<-str_to_lower(summaries$country.etc)
worlddata$country.etc<-str_to_lower(worlddata$country.etc)


#Filtering the needed countries

datall<-worlddata %>% filter(country.etc%in%summaries$country.etc)

#Joining the needed countries and Frequencies

dup_data_joined<-left_join(datall,summaries)

#Extracting a special row for a country in Canada
special_row<-dup_data_joined[dup_data_joined$name=="Edmonton",]
data_joined<-dup_data_joined[!duplicated(dup_data_joined[,c("country.etc")]),]

#Removing the row for Canada and pasting the special row
data_joined<-data_joined[-c(10),]
data_joined<-rbind(data_joined,special_row)

#Making the Countries to upper case letters
data_joined$country.etc<-capitalize(data_joined$country.etc,collapse=" ")
data_joined[data_joined=="Sri lanka"]<-"Sri Lanka"
data_joined[data_joined=="United states"]<-"United States"
data_joined[data_joined=="United kingdom"]<-"United Kingdom"
data_joined[data_joined=="new zealand"]<-"New Zealand"
data_joined[data_joined=="United arab emirates"]<-"United Arab Emirates"
data_joined[data_joined=="New caledonia"]<-"New Caledonia"

#Entering a new column with a text

data_joined<-data_joined%>%
  arrange(Frequency)%>%
  mutate(name=factor(country.etc,unique(country.etc)))%>%
  mutate(mytext=paste("Country: ",name,"\n","Number of Job Advertistments: ",Frequency,sep = ""))



#Plotting the map
plot<-data_joined%>%
  ggplot() +
  geom_polygon(data = data, aes(x=long, y = lat, group = group), fill="grey", alpha=0.9) +
  geom_point( data=data_joined, aes(x=long, y=lat,color=Frequency, text=mytext),size=4) +
   
  scale_color_viridis() +geom_text_repel(data=data_joined %>% arrange(Frequency),aes(x=long,y=lat,label=country.etc),size=3)+
  theme_void() + coord_map()
ggplotly(plot,tooltip = "text")
```


Column {data-width=350}{.tabset .tabset-fade}
-----------------------------------------------------------------------
### C1

```{r}
p <- ggplot(data_joined, aes(x = reorder(country.etc,Frequency), y = Frequency,text=paste("Number of Job Advertistments: ",Frequency)))+
  geom_col( width = 0.7,fill="steelblue")+coord_flip()+ylab("Number of Job Advertistements")+xlab("Country")
ggplotly(p,tooltip="text")


```




```{r, include=FALSE}
#devtools::install_github("thiyangt/DSjobtracker")
library(tidyverse)
library(DSjobtracker)
library(stringr)
#library(dslabs)
library(magrittr)
library(quantmod)
library(plotly)#Currency Converting purposes
```

```{r, include=FALSE}


data("DStidy") 
DStidy %>% head()
str(DStidy)
DStidy$Salary %>% unique() %>% view()

DStidy$Salary %>% str_extract_all("\\$|\\£|�") %>% unlist()
DStidy$Salary %>% str_extract_all("\\d+")%>% unlist() %>%  as.numeric()  %>%  max()


Max_sal<- 
  DStidy$Salary %>% 
  str_remove_all(",") %>%  
  str_extract_all("\\d+\\.?\\d{1,2}") %>% 
  lapply(function(x){as.numeric(x)}) %>%
  lapply(function(x){max(x)}) %>% unlist()
Max_sal[Max_sal==-Inf] <- NA


Currency <- 
  DStidy$Salary %>% 
  str_extract_all("\\$|[A-Z]{2,3}") %>%
  lapply(function(x){return(x[1])}) %>%
  unlist()
Currency <- ifelse(str_detect(DStidy$Salary,"�" )& is.na(Currency), "£", Currency)
Currency

Max_sal %>% is.na() %>% sum()
Currency %>% is.na() %>% sum()



cbind(DStidy$Salary,Max_sal, Currency) %>% view()

NewDF <- data.frame(ID= DStidy$ID, Salary=DStidy$Salary,Max_sal, Currency, Country=DStidy$Job_Country, Job_cat=DStidy$Job_Category,Edu_cat=DStidy$Edu_Category, Experience= DStidy$Experience_Category )
NewDF[NewDF$Country%in%c("Sri Lanka"),"Currency"] <- "LKR"
NewDF[NewDF$Country%in%c("India"),"Currency"] <- "INR"



NewDF %>% filter(!is.na(Max_sal)) %>% select(!Salary)
NewDF %>% filter(Max_sal<1000) %>% select(ID,Salary, Max_sal, Currency)

#Convert Hourly wages to yearly wages
H_ID <- NewDF %>% filter(Max_sal<1000,str_detect(Salary,"hour")) %>% select(ID)
NewDF[NewDF$ID%in%H_ID$ID,"Max_sal"] <- NewDF[NewDF$ID%in%H_ID$ID,"Max_sal"]*8*26*12 #Working 8 hours per day 26 days per month for 12 months

#Convert day wages to yearly wages
D_ID <- NewDF %>% filter(str_detect(Salary,"day")) %>% select(ID, Salary)
NewDF[NewDF$ID%in%D_ID$ID,"Max_sal"] <- NewDF[NewDF$ID%in%D_ID$ID,"Max_sal"]*26*12 #26 days per month for 12 months

#Convert weekly wages to yearly wages
W_ID <- NewDF %>% filter(Max_sal>=1000 & Max_sal<5000) %>% select(ID, Salary)
NewDF[NewDF$ID%in%W_ID$ID,"Max_sal"] <- NewDF[NewDF$ID%in%W_ID$ID,"Max_sal"]*52 #52 weeks per year

#Convert monthly wages to yearly wages
M_ID <- NewDF %>% filter(Max_sal>=10000 & Max_sal<50000 & Currency=="INR") %>% select(ID, Salary)
NewDF[NewDF$ID%in%M_ID$ID,"Max_sal"] <- NewDF[NewDF$ID%in%M_ID$ID,"Max_sal"]*12 #per year

sum(!is.na(NewDF$Currency))
sum(!is.na(NewDF$Max_sal))

Required_DF <- NewDF %>% filter(!is.na(Max_sal))
Required_DF %>% select(Country, Currency) %>% unique()
# Required_DF$Currency <- replace(Required_DF$Currency,list = list("$","£" ), list("USD", "GBP"))

from <- c("GBP", "INR", "LKR","USD")
to <- c("USD", "USD", "USD", "USD")
to2 <- c("LKR","LKR", "LKR", "LKR")

To_USD <- getQuote(paste0(from, to, "=X"))
To_LKR <- getQuote(paste0(from, to2, "=X"))

Conversion_Table <- data.frame(From=from, LKR= To_LKR$Last, USD= To_USD$Last)
Conversion_Table$LKR[is.na(Conversion_Table$LKR)] <- 1
Conversion_Table

Curr_N <- ifelse(Required_DF$Currency=="$", "USD", ifelse(Required_DF$Currency=="£", "GBP", Required_DF$Currency ))
cbind(Curr_N, Required_DF$Currency) %>% unique() # Ao make sure all is converted right
Required_DF <- Required_DF %>% mutate(Std_Currency=Curr_N)

LKR_salary <- Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="USD")*(Conversion_Table[from=="USD", "LKR"])+
  Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="LKR")*(Conversion_Table[from=="LKR", "LKR"])+
  Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="INR")*(Conversion_Table[from=="INR", "LKR"])+
  Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="GBP")*(Conversion_Table[from=="GBP", "LKR"])

USD_salary <- Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="USD")*(Conversion_Table[from=="USD", "USD"])+
  Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="LKR")*(Conversion_Table[from=="LKR", "USD"])+
  Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="INR")*(Conversion_Table[from=="INR", "USD"])+
  Required_DF$Max_sal*as.numeric(Required_DF$Std_Currency=="GBP")*(Conversion_Table[from=="GBP", "USD"])

Required_DF <- Required_DF %>% mutate(LKR_salary, USD_salary) 

```


# Salary - LKR

Row
-----------------------------------------------------------------------

### Chart A: Salary Distribtion
```{r fig.height=3, fig.width=8}

ggplotly(Required_DF %>%  ggplot(aes(LKR_salary))+geom_histogram()+labs(x= paste("Salary in LKR"), y= "Frequency"))

# hist(d_salary, main = paste("Distribution of Salaries in", d))

```

### Chart B: Violin plot of Experience and Salary

```{r}

ggplotly(Required_DF%>% ggplot(aes(x=reorder(Experience,Experience,
                     function(x)-length(x)) , y= LKR_salary ))+geom_violin()+labs(y= paste("Salary in LKR"), x= "Experience")+ theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)))

```

Row
-----------------------------------------------------------------------



### Chart C: Violin plot of Salary and Job Category

```{r}

ggplotly(Required_DF %>% ggplot(aes(x=reorder(Job_cat,Job_cat,
                     function(x)-length(x)) , y= LKR_salary))+geom_violin()+ theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))+labs(y= paste("Salary in LKR"), x= "Job Category"))

```

### Chart D: Violin plot of Salary and Country

```{r}

ggplotly(Required_DF %>% ggplot(aes(x=reorder(Country,Country,
                     function(x)-length(x)) , y= LKR_salary))+geom_violin()+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+labs(y= paste("Salary in LKR"), x= "Country"))

```


# Salary - USD

Row 
-----------------------------------------------------------------------

### Chart A: Salary Distribtion

```{r fig.height=3, fig.width=8}

ggplotly(Required_DF %>%  ggplot(aes(USD_salary))+geom_histogram()+labs(x= paste("Salary in USD"), y= "Frequency"))
# hist(d_salary, main = paste("Distribution of Salaries in", d))

```

### Chart B: Violin plot of Experience and Salary

```{r}

ggplotly(Required_DF%>% ggplot(aes(x=reorder(Experience,Experience,
                     function(x)-length(x)) , y= USD_salary ))+geom_violin()+labs(y= paste("Salary in USD"), x= "Experience")+ theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1)))

```

Row
-----------------------------------------------------------------------



### Chart C: Violin plot of Salary and Job Category

```{r}

ggplotly(Required_DF %>% ggplot(aes(x=reorder(Job_cat,Job_cat,
                     function(x)-length(x)) , y= USD_salary))+geom_violin()+ theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))+labs(y= paste("Salary in USD"), x= "Job Category"))

```

### Chart D: Violin plot of Salary and Country

```{r}

ggplotly(Required_DF %>% ggplot(aes(x=reorder(Country,Country,
                     function(x)-length(x)) , y= USD_salary))+geom_violin()+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+labs(y= paste("Salary in USD"), x= "Country"))

```